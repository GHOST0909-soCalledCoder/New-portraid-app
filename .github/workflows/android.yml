name: Android CI - build & collect outputs

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Show repo root & key files
        run: |
          echo "PWD: $(pwd)"
          echo "Top-level files:"
          ls -la
          echo "Find build.gradle / settings.gradle / AndroidManifest.xml"
          find . -maxdepth 4 -type f \( -name "build.gradle" -o -name "settings.gradle" -o -name "AndroidManifest.xml" \) -print || true

      - name: Ensure Gradle wrapper exists (generate if missing)
        run: |
          if [ -f "./gradlew" ]; then
            echo "gradlew found"
          else
            echo "gradlew not found, generating wrapper via system gradle"
            sudo apt-get update -y
            sudo apt-get install -y gradle unzip
            gradle wrapper --gradle-version 8.1.1
          fi
          chmod +x ./gradlew || true

      - name: Run Gradle build (assembleDebug)
        run: |
          set -x
          ./gradlew :PortraitCameraPro_Full:app:clean :PortraitCameraPro_Full:app:assembleDebug --no-daemon || true
          # also try root assemble in case settings includes other modules
          ./gradlew assembleDebug --no-daemon || true

      - name: Show generated artifacts (find .apk, .aab)
        run: |
          echo "=== Searching for APK / AAB files ==="
          find . -type f \( -iname "*.apk" -o -iname "*.aab" \) -print || true
          echo "=== Show outputs folders (summary) ==="
          du -sh ./* || true
          echo "=== PortraitCameraPro_Full/app build outputs (if exist) ==="
          if [ -d "PortraitCameraPro_Full/app/build/outputs" ]; then
            ls -la PortraitCameraPro_Full/app/build/outputs || true
            find PortraitCameraPro_Full/app/build/outputs -maxdepth 3 -type f -print || true
          else
            echo "No outputs at PortraitCameraPro_Full/app/build/outputs"
          fi
          echo "=== Any other module outputs: */build/outputs ==="
          find . -maxdepth 3 -type d -name "build" -exec sh -c 'ls -la "{}"/outputs || true' \; || true

      - name: Zip entire outputs folder (all modules) for download
        run: |
          mkdir -p ci_artifacts
          # copy any outputs we find into a single folder
          for d in $(find . -type d -name outputs); do
            target="ci_artifacts/$(echo $d | sed 's|^./||' | sed 's|/|_|g')"
            mkdir -p "$target"
            cp -r "$d"/* "$target/" 2>/dev/null || true
          done
          # also include top-level build outputs if present
          if [ -d "build/outputs" ]; then
            mkdir -p ci_artifacts/root_build_outputs
            cp -r build/outputs/* ci_artifacts/root_build_outputs/ 2>/dev/null || true
          fi
          # list what we will upload
          echo "Contents to upload:"
          find ci_artifacts -type f -maxdepth 5 -print || true
          zip -r portrait_outputs.zip ci_artifacts || true

      - name: Upload build outputs zip
        uses: actions/upload-artifact@v4
        with:
          name: portrait-outputs
          path: portrait_outputs.zip